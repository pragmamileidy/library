--- 
id: 6
name: Paso 2 - Datos de Boletas Pendientes de Pago
label: Datos de Boletas Pendientes de Pago
description: "<br><strong style=\"color:#0F698D\"> Revise la informaci\xC3\xB3n obtenida</strong>\r\n\
  <br><strong style=\"color:#82DB28\"> Si tiene boletas pendientes por pago, Usted ser\xC3\xA1 dirigido a la Pasarela de Pagos al avanzar al siguiente paso.</strong>\r\n"
fill_step_id: 3
created_at: 2016-12-23 19:39:46.869833 Z
updated_at: 2017-01-23 15:00:53.375922 Z
include: "{\"14\":{\"7\":{\"66\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"58\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"59\":{\"views\":\"only_view\",\"enabled\":\"disabled\"},\"60\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"61\":{\"views\":\"only_view\",\"enabled\":\"disabled\"},\"62\":{\"views\":\"only_view\",\"enabled\":\"disabled\"},\"63\":{\"views\":\"only_view\",\"enabled\":\"disabled\"},\"64\":{\"views\":\"only_view\",\"enabled\":\"disabled\"},\"65\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"17\":{\"views\":\"hidden\",\"enabled\":\"enabled\"}},\"21\":{\"14\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"16\":{\"views\":\"hidden\",\"enabled\":\"enabled\"},\"38\":{\"views\":\"hidden\",\"enabled\":\"enabled\"},\"41\":{\"views\":\"only_view\",\"enabled\":\"enabled\"},\"15\":{\"views\":\"only_view\",\"enabled\":\"enabled\"},\"67\":{\"views\":\"hidden\",\"enabled\":\"enabled\"}}}}"
allowed_next_to_steps: ""
allowed_back_to_steps: ""
controls: ,back,next,close,close_and_save,save
on_becoming: "#::: DV: 08/09/2016: Obtener valor del config :::#\r\n\
  valor = @config.route(\"Rates-payment-payment-payment\")\r\n\
  if valor == \"Electr\xC3\xB3nico\"\r\n  form_data.set(\"formas_de_pagos_generico.pago_electronico_mensaje.tipo_de_pago_electronico\", \"Pago Electr\xC3\xB3nico\")\r\n\
  end"
on_transition: |-
  #::: Validar se chequee la tabla para pagar el monto de la boleta :::#
  if form_data.get("boletas_por_pagar.monto.motivo_de_la_multa") == "true"
      boletas_selec = form_data.get("boletas_por_pagar.monto.field_oculto")
      boletas = boletas_selec.blank? ? nil : ActiveSupport::JSON.decode(boletas_selec)
      if boletas.blank?
          transition_errors << "Para procesar su pago usted debe seleccionar las boletas a cancelar. Por favor, seleccione un valor en pagar boleta."
      end
  end
      
  #::: CODIGO PARA INVOCAR EL SERVICIO payment_computing_service :::#
  form_id = @task["form"]
  monto_total = form_data.get("boletas_por_pagar.monto.oculto_multa")
  result = WebserviceConsumer.get('/service/helper_update_payment/call.json?method=update_amount_payment&form_id=' + "#{form_id}" + '&amount=' + "#{monto_total}").parsed_response
  if result["response"] == true
      #::: CODIGO PARA INVOCAR EL SERVICIO payment_computing_service
      _applicationId = @application["id"]
      _configRoute = "Rates-rates"
      _formId = @task["form"]
  
      hash = {:application_id => "#{_applicationId}", 
              :config_route   => "#{_configRoute}",
              :form_id        => "#{_formId}"}
      result = PaymentProxy.payment_computing_service(hash)
  
      _payment_id= result["response"]["payment_id"]
      _detail = result["response"]["detail"]
      _total = result["response"]["result"]["total"]
  
      form_data.set("variables_pago_generico.variables_pago_generico.payment",_payment_id)
      form_data.set("variables_pago_generico.variables_pago_generico.detail",_detail)
      form_data.set("datos_del_evaluador_generico.monto_total.monto_total", _total)
      #form_data.set("datos_del_evaluador_generico.monto_total.monto_total","0.01")
  
      result["response"]["result"]["items"].each do |key, value|
          if(key =~ /item_instance_([\d]+)/)
              _i = $1.to_i - 1
              form_data.set("datos_del_evaluador_generico.entidad_evaluadora_#{_i}.nombre_de_la_entidad", value["name"])
              form_data.set("datos_del_evaluador_generico.entidad_evaluadora_#{_i}.pagada", "Iniciada")
              form_data.set("datos_del_evaluador_generico.entidad_evaluadora_#{_i}.monto_a_pagar", value["formula"])
              #form_data.set("datos_del_evaluador_generico.entidad_evaluadora_#{_i}.monto_a_pagar","0.01")
          end 
      end
  else
      transition_errors << "Ha ocurrido un error"
  end
  
  app_id = @application["id"]
  form_data.set("boletas_por_pagar.monto.app_id", app_id)
views: 
back_step: Paso 1 - Consulta de Infracciones
next_step: "Paso 3 \xE2\x80\x93 Realizaci\xC3\xB3n del Pago"
position: 2
ajax_calls: "$(document).ready(function(){ \r\n  $(\"#field_boletas_por_pagar_monto_mensaje_notificacion\").css({'color':'#0F698D','font-size':'1.0em','text-align':'justify','font-weight:':'bold','white-space':'pre-line'});\r\n  $(\"#field_boletas_por_pagar_monto_motivo_de_la_multa\").parents(\".field-box\").hide();\r\n  $(\"#field_boletas_por_pagar_monto_field_oculto\").parents(\".field-box\").hide();\r\n  var boletasSel = $(\"#field_boletas_por_pagar_monto_motivo_de_la_multa\").val();\r\n  if (boletasSel == 'false'){\r\n    $('#field_boletas_por_pagar_monto_monto_de_la_multa').parents(\".field-box\").hide();\r\n    $('#field_boletas_por_pagar_boletas_instance_1_placa').parents(\".part-box\").hide();\r\n    $('#field_boletas_por_pagar_boletas_instance_1_placa').parents(\".part-box\").next().hide()\r\n  }else{\r\n    $(\"#field_boletas_por_pagar_monto_mensaje_notificacion\").parents(\".field-box\").hide();\r\n    $.each( $('[id*=boletas_por_pagar_boletas_]'), function(index, campo) {    \r\n        var pos = (this.id).match(/_instance_[\\d][\\d]/);\r\n        if (pos == null){\r\n          pos = (this.id).match(/_instance_[\\d]/);\r\n        }\r\n        var InicioRuta  = \"#field_boletas_por_pagar_boletas\";\r\n        var boleta     = \"_boleta\";\r\n        var coincide  = InicioRuta.concat(pos);\r\n        var boleta2    = coincide.concat(boleta);\r\n        $(boleta2).parents(\".part-box\").next().hide();\r\n    });\r\n  }\r\n\
  \r\n  $( function() {\r\n    $(\"span\").each (function(){\r\n      if ($(this).html().trim() == \"Secci\xC3\xB3n: Boletas por Pagar\") {  \r\n        $(this).html(\"Detalles de las Boletas\"); \r\n      }\r\n    });\r\n  });\r\n\
  \r\n  $( function() {\r\n    var hint = \"Detalles de las Boletas\";\r\n      $(\"span\").each (function(){\r\n      if ($(this).html().trim() == hint) {  \r\n        $(this).html(hint).css({'color':'#0F698D','font-weight':'bold'}); \r\n      }\r\n    });\r\n  })\r\n\
  });\r\n\
  \r\n\
  \r\n\
  /*\r\n\
  \r\n\
  Legend:\r\n\
  \r\n\
  ==== FIELDS ====\r\n\
  \"0\": Check          (Position)\r\n\
  \"1\": Nro de Boleta  (Position)\r\n\
  \"2\": Nro de Placa   (Position)\r\n\
  \"3\": Fecha          (Position)\r\n\
  \"4\": Motivo         (Position)\r\n\
  \"5\": Imposicion     (Position)\r\n\
  \"6\": Monto Boleta   (Position)\r\n\
  \"7\": Monto Desacato (Position)\r\n\
  \"8\": Monto Total    (Position)\r\n\
  \"9\": Campo Oculto   (Position)\r\n\
  \r\n\
  */\r\n\
  \r\n\
  $(document).ready(function(){\r\n\
  \r\n\
  var show_tickets = $(\"#boletas_por_pagar .section-body .vertical\").children(\".dynamic-element-show\");\r\n\
  var acum         = 0;\r\n\
  \r\n\
  $.fn.hasAttr = function(name) {  \r\n  var attr = this.attr(name)\r\n  return (typeof attr !== typeof undefined && attr !== false);\r\n\
  };\r\n\
  \r\n\
  $.each(show_tickets, function(index, item) {\r\n  \r\n  var label      = $(item).children(\".label2\").find(\".panel-title\");\r\n  var body       = $(item).children(\".part-body\");\r\n  var fields     = $($(body).children(\".vertical\")).children(\".field-box\");\r\n  var check_hist = $(fields[9]).find(\"textarea\").val();\r\n  var checkboxes = $(fields[0]).find(\"input\");\r\n  var isChecked  = check_hist == \"\" ? true\r\n                                    : (check_hist == \"true\" && $(checkboxes[1]).hasAttr(\"checked\"));\r\n  \r\n  var check      = isChecked ? \"checked='checked'\" : \"\";\r\n  \r\n  acum = isChecked ? (acum + parseFloat($(fields[8]).find(\"input\").val())) \r\n                   : acum  + 0;\r\n  \r\n  $(checkboxes[1]).addClass(\"groupHeader\");\r\n  $(checkboxes[1]).prop(\"checked\", isChecked);\r\n\
  \r\n  var label_str = \"\"; // <input  type='checkbox' class='groupHeader' \" + check +\"/> \r\n  label_str    += \"Nro. de Boleta: \" + $(fields[1]).find(\"input\").val() + \" | \";\r\n  label_str    += \"Fecha: \"          + $(fields[3]).find(\"input\").val() + \" | \";\r\n  label_str    += \"Monto Total: \"    + $(fields[8]).find(\"input\").val();\r\n  label.html(label_str);\r\n\
  \r\n  // Set Amount\r\n  $(\"#field_boletas_por_pagar_monto_oculto_multa\").val(acum);\r\n  $(\"#field_boletas_por_pagar_monto_monto_de_la_multa\").html(acum);\r\n\
  \r\n  //$(fields[0]).css(\"display\",\"none\");\r\n  $(fields[1]).css(\"display\",\"none\");\r\n  $(fields[3]).css(\"display\",\"none\");\r\n  $(fields[8]).css(\"display\",\"none\");\r\n\
  \r\n\
  });\r\n\
  \r\n\
  $(\".groupHeader\").click(function(event) {\r\n  var item       = $(this).parents(\".part-box\");\r\n  var body       = $(item).children(\".part-body\");\r\n  var fields     = $($(body).children(\".vertical\")).children(\".field-box\");\r\n  var checkboxes = $(fields[0]).find(\"input\");\r\n  var acum       = 0;\r\n\
  \r\n  $(checkboxes[1]).prop(\"checked\", $(this).is(\":checked\"));\r\n\
  \r\n  if ($(this).is(\":checked\")) {\r\n    acum = roundToTwo(\r\n      parseFloat($(\"#field_boletas_por_pagar_monto_monto_de_la_multa\").text()) + \r\n      parseFloat($(fields[8]).find(\"input\").val())\r\n    );\r\n    $(fields[9]).find(\"textarea\").val(\"true\");\r\n    $(checkboxes[0]).val(\"true\"); // Este valor no se esta guardando en DB\r\n  } else {\r\n    acum = roundToTwo(\r\n      parseFloat($(\"#field_boletas_por_pagar_monto_monto_de_la_multa\").text()) - \r\n      parseFloat($(fields[8]).find(\"input\").val())\r\n    )\r\n    $(fields[9]).find(\"textarea\").val(\"false\");\r\n    $(checkboxes[0]).val(\"false\"); // Este valor no se esta guardando en DB\r\n  }\r\n\
  \r\n  $(\"#field_boletas_por_pagar_monto_oculto_multa\").val(acum);\r\n  $(\"#field_boletas_por_pagar_monto_monto_de_la_multa\").html(acum);\r\n\
  \r\n  build_json_data();\r\n\
  });\r\n\
  \r\n\
  function roundToTwo(value) {\r\n  return (Math.round(value * 100) / 100);\r\n\
  }\r\n\
  \r\n\
  function build_json_data() {\r\n  var tickets   = $(\"#boletas_por_pagar .section-body .vertical\").children(\".dynamic-element-show\");\r\n  var grid_data = [];\r\n\
  \r\n  $.each(tickets, function(index, item) {\r\n    var body       = $(item).children(\".part-body\");\r\n    var fields     = $($(body).children(\".vertical\")).children(\".field-box\");\r\n    var checkboxes = $(fields[0]).find(\"input\");\r\n    var isChecked  = $(checkboxes[1]).is(\":checked\");\r\n\
  \r\n    if (isChecked) {\r\n      row = {};\r\n\
  \r\n      row['checkbox']       = $(checkboxes[0]).is(\":checked\");\r\n      row['Nro de Placa']   = $($(fields[2]).find(\".only_view_label\")).children(\"div\").text();\r\n      row['Nro Boleta']     = $(fields[1]).find(\"input\").val();\r\n      row['Fecha']          = $(fields[3]).find(\"input\").val();\r\n      row['Motivo']         = $($(fields[4]).find(\".only_view_label\")).children(\"div\").text();\r\n      row['Imposici\xC3\xB3n']     = $($(fields[5]).find(\".only_view_label\")).children(\"div\").text();\r\n      row['Monto Boleta']   = $($(fields[6]).find(\".only_view_label\")).children(\"div\").text();\r\n      row['Monto Desacato'] = $($(fields[7]).find(\".only_view_label\")).children(\"div\").text();\r\n      row['Monto Total']    = $(fields[8]).find(\"input\").val();\r\n      row['yml_data']       = \"- Nro de Placa: \" + row['Nro de Placa']      + \"\\n\" +\r\n                              \"  Nro Boleta: \" + row['Nro Boleta']          + \"\\n\" +\r\n                              \"  Fecha: \" + row['Fecha']                    + \"\\n\" +\r\n                              \"  Motivo: \" + row['Motivo']                  + \"\\n\" +\r\n                              \"  Imposici\xC3\xB3n: \" + row['Imposici\xC3\xB3n']          + \"\\n\" +\r\n                              \"  Monto Boleta: \" + row['Monto Boleta']      + \"\\n\" +\r\n                              \"  Monto Desacato: \" + row['Monto Desacato']  + \"\\n\" +\r\n                              \"  Monto Total: \" + row['Monto Total']        + \"\\n\";\r\n\
  \r\n      grid_data.push(row);\r\n    }\r\n  });\r\n  $(\"#field_boletas_por_pagar_monto_campo_data\").val(JSON.stringify(grid_data));\r\n  $(\"#field_boletas_por_pagar_monto_field_oculto\").html(JSON.stringify(grid_data));\r\n\
  }\r\n\
  build_json_data();\r\n\
  });"
