--- 
id: 5
name: Paso 1 - Consulta de Infracciones
label: Consulta de Infracciones
description: ""
fill_step_id: 3
created_at: 2016-12-23 19:39:46.866054 Z
updated_at: 2017-01-24 12:50:08.484453 Z
include: "{\"22\":{\"18\":{\"45\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"57\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"46\":{\"views\":\"only_view\",\"enabled\":\"enabled\"},\"55\":{\"views\":\"default\",\"enabled\":\"enabled\"}},\"19\":{\"3\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"4\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"51\":{\"views\":\"hidden\",\"enabled\":\"enabled\"}}}}"
allowed_next_to_steps: ""
allowed_back_to_steps: ""
controls: ,next,close,close_and_save,save
on_becoming: "#::: Generador de Consecutivos :::#\r\n\
  form_data.set(\"informacion_de_solicitud.datos_de_la_solicitud.fecha_de_solicitud\",@application[\"created_at\"])\r\n\
  result = WebserviceConsumer.get('/consecutive/generador_pagoboletas/generate.json').parsed_response\r\n\
  _consecutivo = result[\"response\"]\r\n\
  _consecutivo = \"#{@application[\"id\"]}-\"+\"#{_consecutivo[\"value\"]}\"\r\n\
  form_data.set(\"informacion_de_solicitud.datos_de_la_solicitud.numero_de_solicitud\",_consecutivo)\r\n\
  \r\n\
  #::: Llenado de Datos del Solicitante\r\n\
  #::: DV: Modificada sentencia 04/10/2016 Datos del Solcitante o Representante legal\r\n\
  _person = @application[\"person_id\"]\r\n\
  _owner = @application[\"owner_person_id\"]\r\n\
  if @owner[\"kind_of_user_type\"] == \"NaturalPerson\"\r\n    if _person == _owner\r\n        tipodoc = !@owner[\"national_id\"].blank? ? \"C\xC3\xA9dula\" : \"Pasaporte\"\r\n        numdoc = !@owner[\"national_id\"].blank? ? @owner[\"national_id\"] : @owner[\"passport\"]\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.tipo_documento_persona_natural\",tipodoc)\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.nro_de_documento\",numdoc)\r\n        form_data.set(\"es_deudor_o_no.es_deudor_o_no.nro_doc\",numdoc)\r\n\
  \r\n        nombre = @owner[\"first_name\"]+\" \"+@owner[\"second_name\"]+\" \"+@owner[\"last_name\"]+\" \"+@owner[\"second_last_name\"]\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.nombre_completo\",nombre)\r\n    else\r\n        _idpersona = @application[\"person_id\"].to_s\r\n        result = WebserviceConsumer.get( '/preconfigured_services/get_user_info.xml?person_id=' + \"#{_idpersona}\" + '&include_all=true').parsed_response\r\n        _hash = result[\"hash\"]\r\n        _persona = _hash[\"response\"]\r\n        tdoc = _persona [\"person_gov_id_type\"] == \"national_id\" ? \"C\xC3\xA9dula\" : \"Pasaporte\"\r\n        form_data.set(\"datos_de_la_persona.representante.tipo_de_documento\",tdoc)\r\n        form_data.set(\"datos_de_la_persona.representante.nro_de_documento\", _persona[\"person_gov_id_number\"])\r\n        form_data.set(\"datos_de_la_persona.representante.nombre_completo\", _persona[\"name\"])\r\n\
  \r\n        tipodoc = !@owner[\"national_id\"].blank? ? \"C\xC3\xA9dula\" : \"Pasaporte\"\r\n        numdoc = !@owner[\"national_id\"].blank? ? @owner[\"national_id\"] : @owner[\"passport\"]\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.tipo_documento_persona_natural\",tipodoc)\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.nro_de_documento\",numdoc)\r\n        form_data.set(\"es_deudor_o_no.es_deudor_o_no.nro_doc\",numdoc)\r\n        nombre = @owner[\"first_name\"]+\" \"+@owner[\"second_name\"]+\" \"+@owner[\"last_name\"]+\" \"+@owner[\"second_last_name\"]\r\n        form_data.set(\"datos_de_la_persona.datos_de_la_persona.nombre_completo\",nombre)\r\n    end\r\n\
  end\r\n\
  \r\n\
  #::: DV: 04/10/2016 Datos del Solcitante Juridico o Representante legal\r\n\
  if @owner[\"kind_of_user_type\"] == \"JuridicalPerson\"\r\n    form_data.set(\"datos_de_la_empresa.datos_de_la_empresa.nro_de_ruc\",@owner[\"tax_id\"])\r\n    form_data.set(\"datos_de_la_empresa.datos_de_la_empresa.razon_social\",@owner[\"name\"])\r\n    form_data.set(\"es_deudor_o_no.es_deudor_o_no.nro_doc\",@owner[\"tax_id\"])\r\n\
  \r\n    _idpersona = @application[\"person_id\"].to_s\r\n    result = WebserviceConsumer.get( '/preconfigured_services/get_user_info.xml?person_id=' + \"#{_idpersona}\" + '&include_all=true').parsed_response\r\n    _hash = result[\"hash\"]\r\n    _persona = _hash[\"response\"]\r\n    tdoc = _persona [\"person_gov_id_type\"] == \"national_id\" ? \"C\xC3\xA9dula\" : \"Pasaporte\"\r\n    form_data.set(\"datos_de_la_empresa.representante.tipo_de_documento\",tdoc)\r\n    form_data.set(\"datos_de_la_empresa.representante.nro_de_documento\", _persona[\"person_gov_id_number\"])\r\n    form_data.set(\"datos_de_la_empresa.representante.nombre_completo\", _persona[\"name\"])\r\n\
  end  "
on_transition: "#::: Si el deudor es el solicitante :::#\r\n\
  deudor = form_data.get(\"es_deudor_o_no.es_deudor_o_no.deudor\")\r\n\
  if deudor == \"Si\"\r\n    tipo_consulta = form_data.get(\"es_deudor_o_no.es_deudor_o_no.tipo_consulta\")\r\n    if tipo_consulta == \"Documento\"\r\n        _person = @application[\"person_id\"]\r\n        _owner = @application[\"owner_person_id\"]\r\n        if @owner[\"kind_of_user_type\"] == \"NaturalPerson\"\r\n            if _person == _owner\r\n                tipodDoc = !@owner[\"national_id\"].blank? ? \"CIP\" : \"PAS\" \r\n            end\r\n        else\r\n            tipodDoc = \"RUC\"\r\n        end\r\n        nro_doc  = form_data.get(\"es_deudor_o_no.es_deudor_o_no.nro_doc\")\r\n    end\r\n\
  \r\n    if tipo_consulta == \"Placa\"\r\n        tipodDoc = \"PLACA\"\r\n        nro_doc  = form_data.get(\"es_deudor_o_no.es_deudor_o_no.placa\")\r\n    end\r\n\
  \r\n    form_data.set(\"es_deudor_o_no.consulta_placa.nro_doc\", tipodDoc)\r\n    #::: Sustituir la consulta del servicio :::#\r\n    result = WebserviceConsumer.get(URI.escape('/service/dummy_bdin_pago_boletas_attt/call.json?method=findSelBoletasPendientesByDoc&nroDocumento=' + \"#{nro_doc}\" + '&tipoDocumento=' + \"#{tipodDoc}\")).parsed_response\r\n\
  else\r\n    #::: Si los deudores son otros :::#                            \r\n    tipo_docD = form_data.get(\"es_deudor_o_no.datos_de_la_persona.tipo_documento\")\r\n    if tipo_docD == \"C\xC3\xA9dula\"\r\n        tipo_docDe = \"CIP\"\r\n    end\r\n    if tipo_docD == \"Pasaporte\"\r\n        tipo_docDe = \"PAS\"\r\n    end\r\n    if tipo_docD == \"Placa\"\r\n        tipo_docDe = \"PLACA\"\r\n    end\r\n    if tipo_docD == \"RUC\"\r\n        tipo_docDe = \"RUC\"\r\n    end\r\n    nro_doc = form_data.get(\"es_deudor_o_no.datos_de_la_persona.dato_a_consultar\")\r\n\
  \r\n    result = WebserviceConsumer.get(URI.escape('/service/dummy_bdin_pago_boletas_attt/call.json?method=findSelBoletasPendientesByDoc&nroDocumento=' + \"#{nro_doc}\" + '&tipoDocumento=' + \"#{tipo_docDe}\")).parsed_response\r\n\
  end\r\n\
  \r\n\
  if !result[\"response\"].blank?\r\n    result[\"response\"].each_with_index do |data, index|\r\n        index += 1\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.boleta\", data[\"infNroDeBoleta\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.placa\", data[\"infNroDePlaca\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.fecha\", data[\"infFechaDeBoleta\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.motivo\", data[\"infDescripcionFalta\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.imposicion\", data[\"infTipoImposicion\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.monto_boleta\", data[\"infMontoBoleta\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.monto_desacato\", data[\"infMontoDesacato\"])\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{index}.monto_total\", data[\"infMontoTotal\"])\r\n        form_data.set(\"boletas_por_pagar.monto.motivo_de_la_multa\", \"true\")\r\n    end\r\n\
  else\r\n    (1..20).each do |x|\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.boleta\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.placa\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.fecha\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.motivo\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.imposicion\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.monto_boleta\", \"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.monto_desacato\",\"\")\r\n        form_data.set(\"boletas_por_pagar.boletas_instance_#{x}.monto_total\",\"\")\r\n    end\r\n    form_data.set(\"boletas_por_pagar.monto.monto_de_la_multa\",\"0\")\r\n    form_data.set(\"boletas_por_pagar.monto.motivo_de_la_multa\", \"false\")\r\n    form_data.set(\"boletas_por_pagar.monto.mensaje_notificacion\",\"Usted no tiene multas pendientes. Avance al pr\xC3\xB3ximo paso.\")\r\n\
  end"
views: 
back_step: ""
next_step: Paso 2 - Datos de Boletas Pendientes de Pago
position: 1
ajax_calls: "//::: DV: Validaci\xC3\xB3n para ocultar seccion de confirmaci\xC3\xB3n si y motivo de solicitud\r\n\
  $(document).ready(function(){\r\n  var valor = $('input[name=\"[field][es_deudor_o_no_es_deudor_o_no_deudor]\"]:checked').val();\r\n  if(valor == undefined){\r\n    $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").hide();\r\n    $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").hide();\r\n    $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n    $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n  }\r\n\
  });\r\n\
  \r\n\
  //::: DV: Funci\xC3\xB3n para ocultar seccion de deudores ::://\r\n\
  $(document).ready(function(){\r\n  $(function() {\r\n    $('input[name=\"[field][es_deudor_o_no_es_deudor_o_no_deudor]\"]').change(function() {\r\n      if ($('input[name=\"[field][es_deudor_o_no_es_deudor_o_no_deudor]\"]:checked').val() == \"No\"){\r\n        $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").show();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').val('');\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').val('');\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').val('');\r\n      }else{\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").show();\r\n        $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").hide();\r\n        $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val('');\r\n        $('#field_es_deudor_o_no_datos_de_la_persona_tipo_documento').val('');\r\n      }\r\n    });\r\n\
  \r\n    //::: Mantener los datos entre pasos ::://\r\n    if ($('input[name=\"[field][es_deudor_o_no_es_deudor_o_no_deudor]\"]:checked').val() == \"No\"){\r\n        $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").show();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n    }else if ($('input[name=\"[field][es_deudor_o_no_es_deudor_o_no_deudor]\"]:checked').val() == \"Si\"){\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").show();\r\n      $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").hide();\r\n    }else{\r\n      $('#field_es_deudor_o_no_datos_de_la_persona_campo_oculto').parents(\".part-box\").hide();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta').parents(\".field-box\").hide();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();;\r\n    }\r\n  });\r\n\
  \r\n  tipo_consulta = $('#field_es_deudor_o_no_es_deudor_o_no_tipo_consulta');\r\n  $(function() {\r\n    tipo_consulta.change(function() {\r\n      if ($(tipo_consulta).find(':selected').val() == \"Placa\"){\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").show();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').val('');\r\n      }else if ($(tipo_consulta).find(':selected').val() == \"Documento\"){\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").show();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').val('');\r\n      }else{\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').val('');\r\n        $('#field_es_deudor_o_no_es_deudor_o_no_placa').val('');\r\n      }\r\n    });\r\n\
  \r\n    //::: Mantener los datos entre pasos ::://\r\n    if ($(tipo_consulta).find(':selected').val() == \"Documento\"){\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").show();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n    }else if ($(tipo_consulta).find(':selected').val() == \"Placa\"){\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").show();\r\n    }else{\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_nro_doc').parents(\".field-box\").hide();\r\n      $('#field_es_deudor_o_no_es_deudor_o_no_placa').parents(\".field-box\").hide();\r\n    }\r\n  });\r\n\
  });\r\n\
  \r\n\
  //::: Limpiar nro de documento cuando se cambia de tipo ::://\r\n\
  $(document).ready(function(){\r\n  TiDoc = $('#field_es_deudor_o_no_datos_de_la_persona_tipo_documento');\r\n  $( function() {\r\n      TiDoc.change(function() {\r\n        if ($(TiDoc).find(':selected').val() == \"\") {\r\n          $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val(\"\");\r\n        }\r\n        if ($(TiDoc).find(':selected').val() == \"C\xC3\xA9dula\") {\r\n          $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val(\"\");\r\n        }\r\n        if ($(TiDoc).find(':selected').val() == \"Pasaporte\") {\r\n          $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val(\"\");\r\n        }\r\n        if ($(TiDoc).find(':selected').val() == \"RUC\") {\r\n          $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val(\"\");\r\n        }\r\n         if ($(TiDoc).find(':selected').val() == \"Placa\") {\r\n          $('#field_es_deudor_o_no_datos_de_la_persona_dato_a_consultar').val(\"\");\r\n        }\r\n    }); \r\n  });    \r\n\
  });\r\n\
  \r\n\
  //::: DV: Cambiar nombre secci\xC3\xB3n y color  paso 1::://\r\n\
  $(document).ready(function(){  \r\n  $( function() {\r\n    $(\"span\").each (function(){\r\n      if ($(this).html().trim() == \"Secci\xC3\xB3n: Datos de la Consulta\") {  \r\n        $(this).html(\"Datos de la Consulta\"); \r\n      }\r\n    });\r\n  });\r\n\
  \r\n  $( function() {\r\n    var hint = \"Datos de la Consulta\";\r\n    $(\"span\").each (function(){\r\n      if ($(this).html().trim() == hint) {  \r\n        $(this).html(hint).css({'color':'#0F698D','font-weight':'bold'}); \r\n      }\r\n    });\r\n  })\r\n\
  });"
