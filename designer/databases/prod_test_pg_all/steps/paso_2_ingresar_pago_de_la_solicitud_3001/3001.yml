--- 
id: 3001
name: "Paso 2- Ingresar Pago de la Solicitud "
label: "Ingresar Pago de la Solicitud "
description: "Ingresar Pago de la Solicitud "
fill_step_id: 1611
created_at: 2014-11-05 14:49:00 Z
updated_at: 2015-08-03 18:58:49 Z
include: "{\"4574\":{\"1824\":{\"1366\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"1367\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"1368\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"1369\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"1371\":{\"views\":\"default\",\"enabled\":\"enabled\"},\"2544\":{\"views\":\"default\",\"enabled\":\"enabled\"}}}}"
allowed_next_to_steps: ""
allowed_back_to_steps: ""
controls: ,back,next,close,close_and_save,save,submit
on_becoming: |-
  # Limpiar el contenido de los campos
  #form_data.set("datos_de_pago.datos_de_pago.numero_de_recibo_deposito", "")
  #form_data.set("datos_de_pago.datos_de_pago.fecha_del_pago", "")
  #form_data.set("datos_de_pago.datos_de_pago.monto_del_pago", "")
  #form_data.set("datos_de_pago.datos_de_pago.banco", "")
  #form_data.set("datos_de_pago.datos_de_pago.observaciones", "")
  #form_data.set("datos_de_pago.datos_de_pago.comprobante_de_pago", "")
  
  form_data.routes.select{|r| r =~ /(\d+)\.pagada/}.each{ |pagada|
    next unless form_data.get(pagada) == 'Iniciada'
    form_data.set(pagada, 'Si')
  }
  
  _montoTotal = form_data.get("datos_del_evaluador_generico.monto_total.monto_total")
  form_data.set("datos_de_pago.datos_de_pago.monto_del_pago",_montoTotal)
on_transition: "##### PAGO MANUAL #####\r\n\
  _applicationId = @application[\"id\"]\r\n\
  _taskId = @task[\"id\"]\r\n\
  \r\n\
  recibo = form_data.get(\"datos_de_pago.datos_de_pago.numero_de_recibo_deposito\")\r\n\
  fecha = form_data.get(\"datos_de_pago.datos_de_pago.fecha_del_pago\")\r\n\
  monto = form_data.get(\"datos_de_pago.datos_de_pago.monto_del_pago\")\r\n\
  banco = form_data.get(\"datos_de_pago.datos_de_pago.banco\")\r\n\
  comprobante = form_data.get(\"datos_de_pago.datos_de_pago.comprobante_de_pago\")\r\n\
  \r\n\
  pago = {\r\n\
  \t\"reference_number\"=> \"#{recibo}\",\r\n\
  \t\"payment_date\"=> \"#{fecha}\",\r\n\
  \t\"bank\"=>\"#{banco}\",\r\n\
  \t\"amount\"=>\"#{monto}\",\r\n\
  \t\"attachment_id\"=>\"#{comprobante}\"\r\n\
  }\r\n\
  \r\n\
  \r\n\
  ### Validaci\xC3\xB3n de Fecha#######\r\n\
  \r\n\
  fecha_pago = form_data.get(\"datos_de_pago.datos_de_pago.fecha_del_pago\") \r\n\
  _error = false\r\n\
  if (fecha_pago.to_date > Date.today)\r\n\
  \t_error = true \r\n\
  \ttransition_errors << \" La fecha del recibo del pago no debe ser mayor a la fecha actual\"\r\n\
  end\r\n\
  \r\n\
  if !_error \r\n\
  \tresult =  PaymentProxy.register_manual_payments(_applicationId,pago, _taskId)\r\n\
  \r\n\
  \tif (!result[:create]) \r\n  \t\ttransition_errors << \"El N\xC3\xBAmero de Deposito Introducido ya ha sido registrado. Su pago no puede ser procesado. Por Favor Verifique\"\r\n\
  \tend\r\n\
  end"
views: 
back_step: ""
next_step: ""
position: 2
ajax_calls: ""
