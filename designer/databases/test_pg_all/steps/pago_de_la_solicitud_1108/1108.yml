--- 
id: 1108
name: Pago de la Solicitud
label: Pago de la Solicitud
description: Pago de la Solicitud
fill_step_id: 564
created_at: 2013-02-03 20:23:21 Z
updated_at: 2013-04-17 19:15:59 Z
include: "{\"2407\":{\"2549\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2550\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2551\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2552\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2553\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2554\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2555\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2558\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2559\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2560\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2561\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2562\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2563\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2564\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2565\":{\"3101\":{\"views\":\"default\",\"enabled\":\"disabled\"},\"2849\":{\"views\":\"default\",\"enabled\":\"disabled\"}},\"2567\":{\"2892\":{\"views\":\"default\",\"enabled\":\"disabled\"}}},\"2596\":{\"2781\":{\"3109\":{\"views\":\"default\",\"enabled\":\"enabled\"}}}}"
allowed_next_to_steps: ""
allowed_back_to_steps: ""
controls: ,next,close,close_and_save,save
on_becoming: |-
  #CODIGO PARA INVOCAR EL SERVICIO payment_computing_service
   _applicationId = @application["id"]
   _configRoute = "EntidadesEvaluadoras-rates"
   _formId = @task["form"]
  result = WebserviceConsumer.get('/payments/payment_computing_service.json?application_id=' + "#{_applicationId}" + '&config_route=' + "#{_configRoute}" + '&form_id=' + "#{_formId}").parsed_response
  
  _i=0
  _payment_id= result["response"]["payment_id"]
  _detail = result["response"]["detail"]
  _total = result["response"]["result"]["total"]
  
  form_data.set("variables_usadas_codigos_p5.variables_p5.payment",_payment_id)
  form_data.set("variables_usadas_codigos_p5.variables_p5.detail",_detail)
  form_data.set("entidad_evaluadora_revisiones.monto_total.monto_total", _total)
  
  result["response"]["result"]["items"].each do |key, value|
  	if(key[0..3]=="item")
  		value.each do |key, value|
  			if(key.downcase=="name")
  				form_data.set("entidad_evaluadora_revisiones.entidad_evaluadora_#{_i}.nombre_de_la_entidad", value)
  			end
  			if(key.downcase=="formula")
  				form_data.set("entidad_evaluadora_revisiones.entidad_evaluadora_#{_i}.monto_a_pagar", value)
  			end
  		end
  	end
  	_i=_i+1
  end
on_transition: |-
  #CODIGO PARA INVOCAR Make Payment, que nos retorna un url
  _manual = form_data.get("pago_manual_confirmado.pago_manual_confirmado.pago_manual_confirmado")
  if (_manual == "No")
  _paymentId = form_data.get("variables_usadas_codigos_p5.variables_p5.payment")
  _consecutiveId = form_data.get("informacion_de_solicitud.datos_de_la_solicitud.numero_de_solicitud")
  
  _id = @current_user.citizen_id_number
  _name = @current_user.name
  _email = @current_user.email
  
  _str = '/payments/make_payment.json?payment_id=' + "#{_paymentId}" + '&id=' + "#{_id}" + '&name=' + "#{_name}" + '&email=' + "#{_email}" + '&consecutive_id=' + "#{_consecutiveId}"
  
  _result = WebserviceConsumer.get(URI.escape(_str)).parsed_response
  _error = _result["error"]
  
  if !_error.nil?
       transition_errors << "Error."
  else
  	#seteos
          _url = _result["response"]
  	form_data.set("variables_usadas_codigos_p5.variables_p5.url",_url)
  end
  end
views: 
back_step: ""
next_step: Ingresar Pago de la Solicitud
position: 0
ajax_calls: ""
